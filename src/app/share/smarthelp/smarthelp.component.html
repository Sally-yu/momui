<nz-modal
  (nzOnCancel)="cancel()"
  (nzOnOk)="ok()"
  [(nzVisible)]="visible"
  [nzTitle]="title"
  class="help-modal">
  <div>
    <nz-input-group [nzAddOnAfter]="helpSearch" nzSearch
                    style="margin-bottom: 8px;margin-right: -40px;padding-right: 40px;">
      <input [(ngModel)]="searchValue" nz-input placeholder="请输入查找关键字" type="text"/>
    </nz-input-group>
    <button
      [nzContent]="menu"
      nz-button nz-popover
      nzPlacement="bottomRight"
      nzTitle="自定义显示列"
      style="float: right;margin-right: 0;"
    ><i nz-icon nzType="setting"></i></button>
  </div>

  <div>
    <ng-template #helpSearch>
      <button nz-button nzSearch nzType="primary"><i nz-icon nzType="search"></i></button>
    </ng-template>

    <nz-table #Table
              [(nzPageIndex)]="pageIndex"
              [(nzPageSize)]="pageSize"
              [nzData]="data"
              [nzLoading]="loading"
              [nzPageSizeOptions]="pageOption"
              [nzScroll]="{x:colWidth(),y:'380px'}"
              [nzShowQuickJumper]="showJumper"
              nzSize="small"
    >
      <thead>
      <tr>
        <th
          (nzCheckedChange)="thChecked($event)"
          [nzChecked]="selected"
          nzLeft="0px"
          nzShowCheckbox
          nzWidth="50px"
        ></th>
        <th *ngFor="let c of displayedCols() " nzWidth="150px">{{c.name}}</th>
      </tr>
      </thead>
      <tbody *ngIf="!tree">
      <tr (click)="rowClick(a)"
          (dblclick)="rowClick(a);ok()" *ngFor="let a of Table.data"
          [ngClass]="{'selected-tr':a==selected}">
        <td (nzCheckedChange)="checkRow($event,a)" [nzChecked]="a==selected"
            nzLeft="0px"
            nzShowCheckbox
        >
        </td>
        <td *ngFor="let c of displayedCols() "
            [title]="c.name+':'+(a[c.code]?a[c.code]:'')">{{a[c.code]}}</td>
      </tr>
      </tbody>

      <tbody *ngIf="tree">
      <ng-container *ngFor="let data of Table.data">
        <ng-container *ngFor="let item of mapOfExpandedData[data[path]]">
          <tr
            (click)="rowClick(item)"
            (dblclick)="rowClick(item);ok()" *ngIf="(item.parent && item.parent.expand) || !item.parent"
            [ngClass]="{'selected-tr':item==selected}">
            <td (nzCheckedChange)="checkRow($event,item)" [nzChecked]="item==selected"
                nzLeft="0px"
                nzShowCheckbox
            >
            <td
              (nzExpandChange)="collapse(mapOfExpandedData[data[path]], item, $event)"
              [(nzExpand)]="item.expand"
              [nzIndentSize]="item.level * 20 "
              [nzShowExpand]="!!item.children"
            >
              {{ item[displayedCols()[0]["code"]] }}
            </td>
            <td *ngFor="let c of displayedCols().slice(1,displayedCols().length)">
              {{ item[c["code"]] }}</td>
          </tr>
        </ng-container>
      </ng-container>
      </tbody>
    </nz-table>

  </div>
  <div *nzModalFooter>
    <button (click)="cancel()" nz-button> 取消</button>
    <button (click)="ok()" [disabled]="!selected" [nzLoading]="loading"
            [nzType]="'primary'" nz-button> 确定
    </button>
  </div>
</nz-modal>

<ng-template #menu>
  <nz-list
    style="padding: 16px;max-height: 300px;overflow-y: auto;"
    [nzDataSource]="columns"
    nzSize="small"
    [nzRenderItem]="smallItem"
  >
    <ng-template #smallItem let-item>
      <nz-list-item [nzContent]="item[name]">
        <nz-switch [nzDisabled]="displayedCols().length<=3&&item['display']" [(ngModel)]="item['display']"
                   style="margin-right: 8px;"></nz-switch>
      </nz-list-item>
    </ng-template>
  </nz-list>
</ng-template>
